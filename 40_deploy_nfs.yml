- name: Create nfs share and registry pv
  hosts: bastion
  become: True
  vars_files:
    - vars/vars.yml
  tasks:

    - name: Prepare disk
      parted:
        device: /dev/vdb
        number: 1
        state: present        

    - name: Create xfs filesystem on /dev/sdb1
      filesystem:
        fstype: xfs
        dev: /dev/vdb1

    - name: Mount up device by label
      mount:
        path: /exports
        src: /dev/vdb1
        fstype: xfs
        state: mounted

    - name: Creating exports file
      template:
        src: templates/nfs_exports.j2
        dest: /etc/exports.d/openshift.exports

    - name: Activating selinux boolean (virt_use_nfs)
      seboolean:
        name: virt_use_nfs
        state: yes
        persistent: yes
   
    - name: Ensuring export registry directory dosen't exists
      file:
        state: absent
        path: /exports/registry
        
    - name: Creating registry export
      file:
        state: directory
        path: "{{ item }}"
        mode: 0775
        owner: nobody
        group: nobody
      loop: 
        - /exports/registry

    - name: Restarting nfs
      service:
        name: nfs-server
        state: started
        enabled: true
